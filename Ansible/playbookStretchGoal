---
- name: Configure VM and deploy NGINX with custom page
  hosts: local
  become: true
  vars:
    nginx_container_name: my_nginx
    nginx_image: nginx:latest
    host_port: 8080
    container_port: 80
    html_dir: /home/azureuser/nginx_html  # local folder for custom page
  tasks:
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present
        update_cache: true

    - name: Ensure pip and dependencies are installed
      apt:
        name:
          - python3-pip
          - python3-setuptools
          - python3-venv
        state: present
        update_cache: true

    - name: Ensure Docker SDK for Python is installed
      pip:
        name: docker
        state: present

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: true

    - name: Create directory for custom HTML
      file:
        path: "{{ html_dir }}"
        state: directory

    - name: Create custom index.html
      copy:
        dest: "{{ html_dir }}/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <title>Team Project</title>
          </head>
          <body>
              <h1>Our Project</h1>
              <p>Team: Awesome Devs</p>
              <p>Project Summary: Deploying a custom NGINX page using Docker and Ansible!</p>
          </body>
          </html>

    - name: Pull NGINX image
      docker_image:
        name: "{{ nginx_image }}"
        source: pull

    - name: Run NGINX container with custom page
      docker_container:
        name: "{{ nginx_container_name }}"
        image: "{{ nginx_image }}"
        state: started
        restart_policy: always
        ports:
          - "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ html_dir }}:/usr/share/nginx/html:ro"  # mount custom HTML
        container_default_behavior: compatibility

    - name: Verify custom NGINX web app is accessible
      uri:
        url: "http://localhost:{{ host_port }}"
        status_code: 200
